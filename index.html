<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
  <META HTTP-EQUIV="refresh" CONTENT="15">
</head>

<body>
</body>

<svg width="960" height="600"></svg>
<?php Header("Cache-Control: max-age=3000, must-revalidate"); ?>

<script src="https://d3js.org/d3.v5.min.js"></script>

<script>

Promise.all([
  d3.csv("data/nodes.csv"),
  d3.csv("data/links.csv"),
]).then(function(data) {
  var nodes_data = data[0]
  var links_data = data[1]

  var width = window.innerWidth
  var height = window.innerHeight

  var svg = d3.select('svg')
  svg.attr('width', width).attr('height', height)

  var linkForce = d3
    .forceLink()
    .id(function (link) { return link.idÂ })

  var simulation = d3
    .forceSimulation(nodes_data)
    .force('link', linkForce)
    .force('charge', d3.forceManyBody().strength(-100))
    .force('center', d3.forceCenter(width / 2, height / 2))

  function getNeighbors(node) {
    return links.reduce(function (neighbors, link) {
        if (link.target.id === node.id) {
          neighbors.push(link.source.id)
        } else if (link.source.id === node.id) {
          neighbors.push(link.target.id)
        }
        return neighbors
      },
      [node.id]
    )
  }

  function isNeighborLink(node, link) {
    return link.target.id === node.id || link.source.id === node.id
  }

  function getLinkColor(node, link) {
    return isNeighborLink(node, link) ? 'green' : '#E5E5E5'
  }

  function getNodeColor(node) {
    if (node.type == 0) {
      return node.percentchangeinstockprice > 0 ? 'blue' : 'yellow'
    }
    return node.candidatewinlost > 0 ? 'green' : 'red'
  }

  function getNodeSize(node) {
    if (node.type == 0) {
      return (5 + 3*Math.abs(node.percentchangeinstockprice)).toString()
    }
    return '5'
  }

  drag = simulation => {

  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }

  return d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended);
}

  function findNeighbors(node) {

  }

  var nodes = svg.append("g")
    .attr("class", "nodes")
    .selectAll("circle")
    .data(nodes_data)
    .enter().append("circle")
      .attr("r", getNodeSize)
      .attr("fill", getNodeColor)
      .call(drag(simulation))

  var links = svg.append("g")
    .attr("class", "links")
    .selectAll("line")
    .data(links_data)
    .enter().append("line")
  	  .attr("stroke", 'gray')
      .attr("stroke-width", 3.0)

  var labels = svg.append("g")
    .attr("class", "text")
    .selectAll("text")
    .data(nodes_data)
    .enter().append("text")
      .text(function (node) { return  node.id })
      .attr("font-family", "Roboto")
  	  .attr("font-size", 10)
      .attr("color", 'black')
  	  .attr("dx", 10)
      .attr("dy", 2)

  simulation.on('tick', () => {
    nodes
      .attr('cx', function (node) { return node.x })
      .attr('cy', function (node) { return node.y })
    labels
      .attr('x', function (node) { return node.x })
      .attr('y', function (node) { return node.y })
    links
      .attr('x1', function (link) { return link.source.x })
      .attr('y1', function (link) { return link.source.y })
      .attr('x2', function (link) { return link.target.x })
      .attr('y2', function (link) { return link.target.y })
  })
  simulation.force("link").links(links_data)
})

</script>
</html>
